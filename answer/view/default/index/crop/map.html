<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=92b308f6aa71230fc03b2fc537b4dcb8"></script>
<script type="text/javascript" src="view/<{$tplName}>/js/DatePicker/WdatePicker.js"></script>
<style>
    #container {width:950px;height:500px;border:1px solid gray; margin-top: 5px;}
</style>
<div id="content">
	<div class="tab">
    	<ul class="tab-label">
             <{if $authconfig.view == true}>
        	<li><a href="<{spUrl c=userRegion a=index tid=$tid sid=$sid}>">用户辖区</a></li>
                <{/if}>
                <{if $authconfig.new == true}>
        	<li ><a href="<{spUrl c=userRegion a=regionNew tid=$tid sid=$sid}>">新增用户辖区</a></li>
                <{/if}>
               
                <li  class="current"><a href="<{spUrl c=userRegion a=regionMap tid=$tid sid=$sid}>">用户辖区地图</a></li>
                
        </ul>
		<div id="showAdviceButton"></div>
		<div>
                <div style="position:absolute; right:10px; top:11px; z-index:999; width:auto; text-align:right; line-height:14px;">
    <a href="<{spUrl c=user a=$pc sid=$sid tid=$tid}>">[返回]</a>
</div>
            </div>
        <div class="more" style='left:400px;'>
        	<span class='colBlue'>TIPS:当前用户为：[<{$current_uname}>]</span>
        
        </div>	
<div class="tab-main">
	<p id="udError" class="dBox" style="display:none;"></p>
		
               <div id="container"></div>
	

	</div>
</div>
</div>
<script type="text/javascript">
var map = new BMap.Map("container");
map.centerAndZoom(new BMap.Point(106.680688,29.566473), 5);
map.addControl(new BMap.NavigationControl({type: BMAP_NAVIGATION_CONTROL_SMALL}));
map.enableScrollWheelZoom();
</script>
<script type="text/javascript">
$(document).ready(function(){
	//搜索区域回车事件
	drawRegion();
	
	jQuery.ajax({
		type: 'get',
		url: "<{spUrl c=advice a=showButton module=$adviceModule position='报表中心->成员轨迹'|escape:'url'}>",
		success: function(data,html){jQuery("#showAdviceButton").html(data); },
		error: function(){}
	});
});
function drawRegion()
{
    jQuery.ajax({
		type: 'post',
                dataType:'json',
                data:{user_id:'<{$current_user_id}>'},
		url: "<{spUrl c=userRegion a=getMapData sid=$sid tid=$tid}>",
		success: function(data,html){
                    
                    if(data.status == '0'){
                        //在地图上画出区域来
                        
                        drawArea(data.data);
                    }else{
                        alert(data.msg);
                    }
                },
		error: function(){}
	});
}
function drawArea(data){
    
    map.clearOverlays();        //清除地图覆盖物
    for(var key in data){
        var type = data[key]['type'];
        if(type != '4'){
            //alert(data[key]['detail']);
            getBoundary(data[key]['detail']);
        }else{
            //自定义行政区
            getCustomArea(data[key]['detail']);
        }
    }
   
}
function getCustomArea(data){
    var point_list = new Array();
    //var i = 0;
    for(var key in data)
      {
        //alert(data[key].lng);
        point_list[key] = new BMap.Point(data[key].lng, data[key].lat);
        //i = i+1;
        }
    var ply = new BMap.Polygon(point_list, {strokeWeight: 2, strokeColor: "#ff0000"}); //建立多边形覆盖物
    map.addOverlay(ply);  //添加覆盖物
    map.setViewport(ply.getPath());    //调整视野 
}
function getBoundary(distictName){       
    var bdary = new BMap.Boundary();
    var name = distictName;
    bdary.get(name, function(rs){       //获取行政区域
        //map.clearOverlays();        //清除地图覆盖物       
        var count = rs.boundaries.length; //行政区域的点有多少个
        for(var i = 0; i < count; i++){
			
            var ply = new BMap.Polygon(rs.boundaries[i], {strokeWeight: 2, strokeColor: "#ff0000"}); //建立多边形覆盖物
            map.addOverlay(ply);  //添加覆盖物
            map.setViewport(ply.getPath());    //调整视野         
        }                
    });   
}
</script>